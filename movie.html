const API_KEY = "vajiraofficial";

async function performSearch() {
    const query = document.getElementById('searchInput').value;
    const list = document.getElementById('results-list');
    const loader = document.getElementById('searchLoader');

    if (!query) return;

    list.innerHTML = "";
    loader.style.display = "block";

    try {
        const res = await fetch(`https://vajira-mv-apikeys.netlify.app/api/sinhalasubs/search?q=${encodeURIComponent(query)}&apikey=${API_KEY}`);
        
        if (!res.ok) throw new Error("Server response was not OK");

        const result = await res.json();
        
        // Safety Check: Navigate through the object safely
        const movies = result?.data?.data?.data || result?.data?.data || [];

        if (movies.length === 0) {
            list.innerHTML = "<p style='text-align:center; opacity:0.6;'>No movies found.</p>";
            return;
        }

        // The Loop
        movies.forEach(mv => {
            // Check if title exists before creating the element
            if (mv.title) {
                const row = document.createElement('div');
                row.className = 'movie-row';
                row.innerHTML = `
                    <b>${mv.title}</b> 
                    <i class="fa-solid fa-circle-play" style="color:#f5576c"></i>
                `;
                row.onclick = () => showMovieProfile(mv.link);
                list.appendChild(row);
            }
        });

    } catch (e) {
        console.error("Search Error:", e);
        alert("Search failed. The API might be down or the key is invalid.");
    } finally {
        loader.style.display = "none";
    }
}

async function showMovieProfile(movieUrl) {
    document.getElementById('view-search').style.display = "none";
    document.getElementById('view-profile').style.display = "block";
    const container = document.getElementById('profile-content');
    container.innerHTML = "<div class='loader' style='display:block'>LOADING DETAILS...</div>";

    try {
        const res = await fetch(`https://vajira-mv-apikeys.netlify.app/api/sinhalasubs/details?url=${movieUrl}&apikey=${API_KEY}`);
        const result = await res.json();
        
        // Deep access to the data
        const info = result.data.data.mainDetails;
        const downloads = result.data.data.dllinks.DownloadLinks;

        let downloadButtons = "";
        if (downloads && downloads.length > 0) {
            downloads.forEach(dl => {
                downloadButtons += `
                    <div class="dl-card" onclick="finalDownload('${dl.link}')">
                        <b>${dl.quality || 'HD'}</b>
                        <span>${dl.size || 'Unknown Size'} ‚Ä¢ ${dl.type || 'Direct'}</span>
                    </div>`;
            });
        }

        container.innerHTML = `
            <div class="profile-flex">
                <img src="${info.imageUrl}" class="poster-img" onerror="this.src='https://via.placeholder.com/250x375?text=No+Image'">
                <div class="details-info">
                    <h2>${info.maintitle}</h2>
                    <div class="meta-tags">
                        <span class="tag">${info.dateCreated || ''}</span>
                        <span class="tag">‚≠ê ${info.imdbRating || 'N/A'}</span>
                        <span class="tag">${info.country || ''}</span>
                    </div>
                    <p class="description">${info.description || 'No description available.'}</p>
                    <p style="margin-bottom:8px"><b>üé¨ Director:</b> ${info.director || 'Unknown'}</p>
                    <p><b>üé≠ Genres:</b> ${info.genres ? info.genres.join(', ') : 'N/A'}</p>
                </div>
            </div>
            <div class="dl-section">
                <h3>Download Subtitled Movie</h3>
                <div class="dl-grid">${downloadButtons || '<p>No links available</p>'}</div>
            </div>
        `;
    } catch (e) {
        container.innerHTML = "<div style='padding:20px;'>Error loading movie info. Please try again.</div>";
    }
}

async function finalDownload(shortLink) {
    alert("Generating direct link...");
    try {
        const res = await fetch(`https://vajira-mv-apikeys.netlify.app/api/sinhalasubs/download?url=${shortLink}&apikey=${API_KEY}`);
        const result = await res.json();
        const finalLink = result.data?.data?.link;

        if (finalLink) {
            window.open(finalLink, '_blank'); // Opens in new tab
        } else {
            alert("Could not extract link.");
        }
    } catch (e) {
        alert("Error in direct download API.");
    }
}

function goBack() {
    document.getElementById('view-search').style.display = "block";
    document.getElementById('view-profile').style.display = "none";
}
