<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vajira Movie Box - All-in-One</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #ff1e2a; 
            --primary-glow: rgba(255, 30, 42, 0.4);
            --bg: #0a0a0a; 
            --card: #121212; 
            --text: #ffffff; 
            --accent: #38bdf8; 
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; scroll-behavior: smooth; }
        
        /* Header & Search */
        .header { padding: 20px; background: #000; border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 1000; }
        .search-box { max-width: 600px; margin: 0 auto; display: flex; gap: 10px; background: #1a1a1a; padding: 5px; border-radius: 12px; border: 1px solid #333; }
        input { flex: 1; background: transparent; border: none; color: white; padding: 12px; outline: none; font-size: 1rem; }
        .main-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .main-btn:disabled { background: #555; cursor: not-allowed; }

        /* Grid Section */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        .section-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 25px; color: #fff; border-left: 5px solid var(--primary); padding-left: 15px; }
        .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 50px; }
        
        /* Movie Card */
        .movie-card { background: var(--card); border-radius: 12px; overflow: hidden; transition: 0.3s; cursor: pointer; border: 1px solid #222; position: relative; display: flex; flex-direction: column; height: 100%; }
        .movie-card:hover { transform: translateY(-8px); border-color: var(--primary); }
        .badge-container { position: absolute; top: 10px; left: 10px; display: flex; flex-wrap: wrap; gap: 5px; z-index: 10; }
        .badge { font-size: 0.65rem; font-weight: 800; padding: 3px 7px; border-radius: 4px; text-transform: uppercase; color: white; }
        .badge.year { background: #3b82f6; }
        .badge.rating { background: #f59e0b; color: #000; }
        .image-container { position: relative; width: 100%; padding-top: 145%; background: #1a1a1a; }
        .movie-card img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .card-info { padding: 15px; background: linear-gradient(to top, #000 85%, transparent); margin-top: -70px; position: relative; flex-grow: 1; display: flex; align-items: flex-end; }
        .card-title { font-size: 0.85rem; font-weight: 600; line-height: 1.3; color: #fff; text-align: center; width: 100%; text-shadow: 2px 2px 4px #000; }

        /* Detail View Styles */
        #detailSection { display: none; padding-top: 40px; border-top: 2px solid #222; margin-top: 50px; }
        .movie-main { display: grid; grid-template-columns: 300px 1fr; gap: 40px; margin-bottom: 50px; }
        .poster-detail { width: 100%; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border: 1px solid #333; }
        .badge-row { display: flex; gap: 12px; align-items: center; margin: 15px 0; }
        .imdb-badge { background: #f5c518; color: #000; padding: 3px 10px; border-radius: 5px; font-weight: 800; font-size: 0.85rem; }
        .meta-tag { color: #888; font-size: 0.85rem; }
        .description { color: #aaa; font-size: 1rem; line-height: 1.6; margin: 20px 0; }
        .section-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: var(--primary); font-weight: 800; margin-bottom: 20px; display: block; }
        .gallery-wrapper { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 40px; }
        .gallery-wrapper img { height: 140px; border-radius: 10px; border: 1px solid #222; }

        /* Download Section */
        .download-card { background: linear-gradient(145deg, #151515, #0a0a0a); border-radius: 20px; padding: 30px; border: 1px solid #222; }
        .dl-row { display: flex; justify-content: space-between; align-items: center; padding: 18px; margin-bottom: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; }
        .dl-action-btn { background: linear-gradient(90deg, #1a1a1a, #252525); color: #fff; border: 1px solid #333; padding: 12px 24px; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
        .dl-action-btn:hover { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }

        @media (max-width: 800px) {
            .movie-main { grid-template-columns: 1fr; }
            .poster-detail { max-width: 250px; margin: 0 auto; display: block; }
            .movie-grid { grid-template-columns: repeat(2, 1fr); }
            .dl-row { flex-direction: column; gap: 15px; text-align: center; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search Movie name...">
        <button id="searchBtn" class="main-btn" onclick="searchMovies()">SEARCH</button>
    </div>
</div>

<div class="container">
    <div class="section-title" id="statusText">Featured Movies</div>
    <div id="loading" style="display:none; text-align:center; padding: 40px; color: var(--primary); font-weight: bold;">Loading...</div>
    
    <div class="movie-grid" id="movieGrid"></div>

    <div id="detailSection">
        <div id="movieDetailsContainer"></div>
    </div>
</div>

<script>
    const apikey = "vajiraofficial";
    const proxy = "https://api.allorigins.win/get?url=";

    // Handle Search
    async function searchMovies() {
        const query = document.getElementById('searchInput').value.trim();
        const grid = document.getElementById('movieGrid');
        const status = document.getElementById('statusText');
        const loader = document.getElementById('loading');
        
        if (!query) return;

        grid.innerHTML = '';
        document.getElementById('detailSection').style.display = 'none';
        loader.style.display = 'block';
        status.innerText = `Searching for: ${query}`;

        const searchUrl = `https://vajira-mv-apikeys.netlify.app/api/pirate/search?q=${encodeURIComponent(query)}&apikey=${apikey}`;

        try {
            const resp = await fetch(proxy + encodeURIComponent(searchUrl));
            const json = await resp.json();
            const result = JSON.parse(json.contents);
            const moviesArray = result?.data?.data?.data || result?.data?.data || [];

            loader.style.display = 'none';

            if (moviesArray.length === 0) {
                status.innerText = "No results found";
                return;
            }

            status.innerText = `Results for: ${query}`;
            moviesArray.forEach(movie => {
                const poster = movie.imageSrc || movie.image || 'https://via.placeholder.com/300x450';
                const card = document.createElement('div');
                card.className = 'movie-card';
                // Pass the movie link to the detail fetcher
                card.onclick = () => fetchMovieDetails(movie.link);
                card.innerHTML = `
                    <div class="badge-container">
                        <span class="badge year">${movie.year || 'N/A'}</span>
                        ${movie.rating ? `<span class="badge rating">${movie.rating}</span>` : ''}
                    </div>
                    <div class="image-container">
                        <img src="${poster}" alt="poster">
                    </div>
                    <div class="card-info">
                        <div class="card-title">${movie.title}</div>
                    </div>`;
                grid.appendChild(card);
            });
        } catch (e) {
            loader.style.display = 'none';
            status.innerText = "Error searching. Try again.";
        }
    }

    // Handle Details (Triggered when movie card clicked)
    async function fetchMovieDetails(movieUrl) {
        const detailSection = document.getElementById('detailSection');
        const container = document.getElementById('movieDetailsContainer');
        
        detailSection.style.display = 'block';
        container.innerHTML = '<div style="text-align:center; padding:50px;">Fetching full movie data...</div>';
        
        // Scroll to details
        detailSection.scrollIntoView({ behavior: 'smooth' });

        const apiUrl = `https://vajira-mv-apikeys.netlify.app/api/pirate/movie?url=${encodeURIComponent(movieUrl)}&apikey=${apikey}`;

        try {
            const resp = await fetch(proxy + encodeURIComponent(apiUrl));
            const jsonWrapper = await resp.json();
            const result = JSON.parse(jsonWrapper.contents);
            
            const movie = result.data.data.mainDetails;
            const extra = result.data.data.moviedata;
            const links = result.data.data.dllinks.directDownloadLinks;

            container.innerHTML = `
                <div class="movie-main">
                    <img src="${movie.imageUrl}" class="poster-detail">
                    <div class="info">
                        <h1 style="font-size:2.5rem; margin:0; line-height:1.1; font-weight:800;">${movie.maintitle}</h1>
                        <div class="badge-row">
                            <span class="imdb-badge">IMDb ${extra.imdbRating}</span>
                            <span class="meta-tag">${movie.dateCreated}</span>
                            <span class="meta-tag">•</span>
                            <span class="meta-tag">${movie.runtime}</span>
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:25px;">
                            ${movie.genres.map(g => `<span style="background:rgba(255,255,255,0.05); border:1px solid #333; padding:5px 14px; border-radius:6px; font-size:0.75rem; font-weight:700; color:#ddd;">${g}</span>`).join('')}
                        </div>
                        <span class="section-label">Synopsis</span>
                        <p class="description">${extra.description}</p>
                        <div style="font-size:0.85rem; border-top:1px solid #222; padding-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                            <div><b style="color:var(--primary); text-transform:uppercase; font-size:0.7rem;">Director</b><br>${extra.director}</div>
                            <div><b style="color:var(--primary); text-transform:uppercase; font-size:0.7rem;">Country</b><br>${movie.country}</div>
                        </div>
                    </div>
                </div>

                <span class="section-label">Media Gallery</span>
                <div class="gallery-wrapper">
                    ${extra.imageUrls.map(url => `<img src="${url}" onclick="window.open(this.src)">`).join('')}
                </div>

                <div class="download-card">
                    <span class="section-label">Download Options</span>
                    ${links.map(l => `
                        <div class="dl-row">
                            <div class="dl-info">
                                <b style="color:var(--primary)">${l.quality}</b><br>
                                <span style="color:#666; font-size:0.85rem;">${l.size} • ${l.platform}</span>
                            </div>
                            <button onclick="handleDownload('${l.link}', this)" class="dl-action-btn">
                                <span>Get File</span>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (e) {
            container.innerHTML = '<div style="text-align:center; color:var(--primary);">Error loading details.</div>';
        }
    }

    async function handleDownload(linkUrl, btn) {
        const originalContent = btn.innerHTML;
        btn.innerHTML = "<span>Bypassing...</span>";
        btn.disabled = true;

        const downloadApi = `https://vajira-mv-apikeys.netlify.app/api/pirate/download?url=${encodeURIComponent(linkUrl)}&apikey=${apikey}`;

        try {
            const resp = await fetch(proxy + encodeURIComponent(downloadApi));
            const jsonWrapper = await resp.json();
            const result = JSON.parse(jsonWrapper.contents);
            let finalLink = result.data.data.link;

            if (finalLink) {
                const fixedLink = finalLink.replace('api/file/', 'u/');
                window.open(fixedLink, '_blank');
            }
        } catch (e) {
            alert("Error generating download.");
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchMovies(); });
</script>

</body>
</html>
